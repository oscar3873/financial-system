{% extends "core/base.html" %} {% block content %} {% load static %}
<!--Main-->
<link href="{% static 'cashregister/css/cashregister.css' %}" rel="stylesheet">
<main class="container my-4">
    <!--Seccion 1-->
    <h3 class="title font-weight-normal">{{client.first_name}} {{client.last_name}}</h3>
    {% if messages %} {% for message in messages %}
    <div class="alert alert-{{message.extra_tags}} alert-dismissible" role="alert">
        <span type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></span>
        <span class="font-weight-light">{{ message }}</span>
    </div>
    {% endfor %} {% endif %}
    <section>
        <div class="row mt-4">
            <div class="col-xl-3 col-sm-6 col-12 p-3">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <div class="media d-flex">
                                <div class="align-self-center">
                                    <i class="fa-sharp fa-solid fa-credit-card text-warning icon-lg"></i>
                                </div>
                                <div class="media-body text-right">
                                    <h5>{{client.score}}</h5>
                                    <h5>Score</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer p-1 bg-info rounded-bottom"></div>
                </div>
            </div>
            <div class="col-xl-5 col-sm-6 col-12 p-3">
                <div class="card">
                    <h5 class="title pt-3 text-center">Datos Personales</h5>
                    <div class="d-flex justify-content-around">
                        <div class="px-2">
                            <p>Domicilio: <strong>{{client.address}}</strong></p>
                            <p>Estado civil: <strong>{{client.get_civil_status_display}}</strong></p>
                            <p>Profesion: <strong>{{client.profession}}</strong></p>
                        </div>
                        <div>
                            <p>DNI: <strong>{{client.dni}}</strong></p>
                            <p>Domicilio Laboral: <strong>{{client.job_address}}</strong></p>
                        </div>
                    </div>
                    <p class="px-4">Correo: <strong>{{client.email}}</strong></p>
                    <div class="card-footer p-1 bg-info rounded-bottom"></div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 col-12 p-3">
                <div class="card">
                    <h5 class="title pt-3 text-center">Datos Garante</h5>
                    <div class="d-flex justify-content-around">
                        <div class="px-2">
                            <p>Domicilio: <strong>{{client.address}}</strong></p>
                            <p>Estado civil: <strong>{{client.get_civil_status_display}}</strong></p>
                            <p>Profesion: <strong>{{client.profession}}</strong></p>
                        </div>
                        <div class="px-1">
                            <p>DNI: <strong>{{client.dni}}</strong></p>
                            <p>Domicilio Laboral: <strong>{{client.job_address}}</strong></p>
                        </div>
                    </div>
                    <p class="px-2">Correo: <strong>{{client.email}}</strong></p>
                    <div class="card-footer p-1 bg-info rounded-bottom"></div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 col-12 p-3">
                <div class="card bg-primary text-white media p-4">
                    <h5 class="title py-3">Registro</h5>
                    <p class="m-0">Asesor Financiero</p>
                    <p><a class="text-warning" href="{% url 'advisers:detail' client.adviser.pk %}"><strong>{{client.adviser}}</strong></a></p>
                    <p class="m-0">Fecha de Entrada al sistema</p>
                    <p><strong>{{client.created_at|date}}</strong></p>
                    <h5 class="title pt-3">Creditos</h5>
                    {% if credits %}
                    <p>Cantidad de Creditos </p>
                    <p>Tiene un credito activo</p>
                    {% else %}
                    <p>No se registraron Creditos</p>
                    {% endif %}
                </div>
            </div>
            {% if credit_active %}
            <div class="col-xl-9 col-sm-6 col-12 p-3">
                <div class="card">
                    <h5 class="title pt-3 text-start pl-4">
                        <strong class="text-success">●</strong> Credito Activo</h5>
                    <div class="d-flex justify-content-start">
                        <div class="px-4">
                            <p class="text-start">Monto solicitado:</p>
                            <p class="text-start">Monto a devolver:</p>
                            <p class="text-start">Cuotas:</p>
                        </div>
                        <div class="px-4">
                            <p class="text-start"><strong>$ {{credit_active.amount}}</strong></p>
                            <p class="text-start"><strong>$ {{credit_active.credit_repayment_amount}}</strong></p>
                            <p class="text-start"><strong>{{credit_active.installment_num}}</strong></p>
                        </div>
                        <div class="form-group">
                            <!-- BOTON MODAL PARA PAGOS DE CUOTAS -->
                            {% if installments_available %}
                                {% include "payment/payment_form.html" %}
                            {% endif %}
                        </div>
                    </div>
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Cuota</th>
                                <th scope="col">Monto de la cuota</th>
                                <th scope="col">Fecha de vencimiento</th>
                                <th scope="col">Estado</th>
                                {% if installments_available %}
                                <th scope="col">Refinanciacion</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for installment in installments %}
                            <tr>
                                <td>{{installment.installment_number}}</td>
                                <td>{{installment.amount}}</td>
                                <td>{{installment.end_date|date}}</td>
                                {% if installment.is_paid_installment %}
                                <td>
                                    <div class="alert alert-success m-0 p-1 text-center rounded-pill" role="alert">
                                        <strong>● Pagada</strong>
                                    </div>
                                </td>
                                {% elif installment.is_caduced_installment %}
                                <td>
                                    <div class="alert alert-danger m-0 p-1 text-center rounded-pill" role="alert">
                                        <strong>● Vencida</strong>
                                    </div>
                                </td>
                                {% elif installment.is_refinancing_installment %}
                                <td>
                                    <!-- PONER BOTON PARA VER DETALLE DE LA REFINANCIACION  -->
                                    <a href="#">
                                        <div class="alert alert-secondary m-0 p-1 text-center rounded-pill" role="alert">
                                            <strong>● Refinanciada</strong>
                                        </div>
                                    </a>
                                </td>
                                {% else %}
                                <td>
                                    <div class="alert alert-warning m-0 p-1 text-center rounded-pill" role="alert">
                                        <strong>● A Tiempo</strong>
                                    </div>
                                </td>
                                {% endif %}
                                    
                                {% if first_is_paid and installments_available %}

                                <td>
                                    <div type="button" class="btn" data-toggle="modal" data-target="#exampleModal{{credit_active.pk}}">
                                        <strong class="alert alert-primary m-0 p-1 text-center rounded-pill" role="alert">Refinanciar</strong>
                                    </div>
                                </td>
                                <!--Modal-->
                                    <div class="modal fade" id="exampleModal{{credit_active.pk}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel{{credit_active.pk}}" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <form action="{% url 'credits:refinance' credit_active.pk %}" method="POST">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="exampleModalLabel">Refinanciacion de Cuotas</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <h5 id="selected-count">Valor por Cuota $ {{amount_installment}}</h5>
                                                        {% csrf_token %}
                                                        {{form_ref.as_p}}
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button class="btn btn-success">Refinanciar</button>
                                                        <button type="button" class="btn btn-info m-2 rounded p-2" data-dismiss="modal">Cerrar</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="card-footer p-1 bg-info rounded-bottom"></div>
                </div>
            </div>
            {% else %}
            <div class="col-xl-9 col-sm-6 col-12 p-3 text-center">
                <h5 class="title pt-3">
                    <strong class="text-danger">●</strong> Sin credito activo</h5>
            </div>
            {% endif %}

        </div>
        <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 col-12 p-3">
            </div>
        </div>
    </section>
</main>


<script>
    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-form-id="form_ref"]');
    const selector = document.querySelector('#id_installment_num_refinancing');
    const sumElement = document.querySelector('#id_amount');
    const interestElement = document.querySelector('#interest');
    var porcentaje;
    
    function calcularSuma() {
        let sum = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                sum += parseFloat(checkbox.value);
            }
        });
        
        console.log(selector.value);
        switch(parseInt(selector.value)){
            case 3: porcentaje=25;break;
            case 6: porcentaje=50;break;
            case 9: porcentaje=75;break;
            default: porcentaje=100;break;
        }
        const selectorValue = parseFloat(selector.value);
        const total = (sum * (porcentaje+100)/100).toFixed(2);
        sumElement.value = `${total}`;
        updateSelectedCount();
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', calcularSuma);
    });
    if (`{{amount_installment}}`){
        selector.addEventListener('change', calcularSuma);
    }
    function updateSelectedCount() {
        const selectedCountH5 = document.getElementById('selected-count');
        const selected = Array.from(checkboxes).filter((c) => c.checked);
        const selectedCount = selected.length;
        
        if (selectedCount === 0) {
            selectedCountH5.textContent = `Valor por Cuota $ {{amount_installment}}` ;
        } else if (selectedCount === 1) {
            selectedCountH5.textContent = `Valor por Cuota $ {{amount_installment}} + ${porcentaje}%`;
        } else {
            selectedCountH5.textContent = `Valor por Cuota $ {{amount_installment}} + ${porcentaje}%`;
        }
    }

</script>


{% endblock content %}