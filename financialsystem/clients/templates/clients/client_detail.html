{% extends "core/base.html" %} {% block content %} {% load static %}
<!--Main-->
<link href="{% static 'clients/css/client_detail.css' %}" rel="stylesheet">
<main class="container my-4">
    <!--Seccion 1-->
    <h4 class="title font-weight-normal animate__fadeInLeft" style="animation-duration: 0.5s !important;">{{client.first_name}} {{client.last_name}}</h4>
    {% if messages %} {% for message in messages %}
    <div class="alert alert-{{message.extra_tags}} alert-dismissible" role="alert">
        <span type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></span>
        <span class="font-weight-light">{{ message }}</span>
    </div>
    {% endfor %} {% endif %}
    <section>
        <div class="row justify-content-center">
            <div class="col-xl-3 col-sm-3 col-12 p-3">
                <!-- Swiper -->
                <div class="swiper SwiperCards">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <div class="card bg-primary box-shadow text-white">
                                <div class="card-body">
                                    <h5 class="card-title animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-trophy text-warning"></i>&nbsp;Score</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="text-warning font-weight-bold">{{client.score_label}}</p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-around align-items-center">
                                        {% if client.score_label == "Exelente" or client.score_label == "Muy Bueno" %}
                                        <div class="led-success"></div>
                                        {% elif client.score_label == "Bueno" %}
                                        <div class="led-warning"></div>
                                        {% else %}
                                        <div class="led-danger"></div>
                                        {% endif %}

                                        <span class="text-white" style="font-size: 2rem">{{client.score}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="card bg-primary box-shadow text-white">
                                <div class="card-body">
                                    <h5 class="card-title animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-trophy text-warning"></i>&nbsp;Score</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="text-warning font-weight-bold">{{client.score_label}}</p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-around align-items-center">
                                        {% if client.score_label == "Exelente" or client.score_label == "Muy Bueno" %}
                                        <div class="led-success"></div>
                                        {% elif client.score_label == "Bueno" %}
                                        <div class="led-warning"></div>
                                        {% else %}
                                        <div class="led-danger"></div>
                                        {% endif %}

                                        <span class="text-white" style="font-size: 2rem">{{client.score}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
                <div class="card bg-primary my-2 border-0 text-white box-shadow ">
                    <a name="" id="" class="btn btn-secondary rounded p-3" href="{% url 'credits:associate_credit_for_customer' client.pk %}" role="button">
                        <i class="fa fa-plus-circle" aria-hidden="true"></i>
                        <span>Agregar nuevo credito</span>
                    </a>
                </div>
            </div>
            <div class="col-xl-5 col-sm-6 col-12 p-3">
                <!-- Swiper -->
                <div class="swiper SwiperData">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide" style="height: auto;">
                            <div class="card bg-primary text-white">
                                <h5 class="title pt-3 text-center"><i class="fas fa-id-card text-warning"></i> Datos Personales</h5>
                                <div class="d-flex justify-content-around">
                                    <div class="px-2">
                                        <p><span>Domicilio: </span><strong class="text-warning">{{client.address}}</strong></p>
                                        <p><span>Estado civil: </span><strong class="text-warning">{{client.get_civil_status_display}}</strong></p>
                                        <p><span>Profesion: </span><strong class="text-warning">{{client.profession}}</strong></p>
                                    </div>
                                    <div>
                                        <p><span>DNI: </span><strong class="text-warning">{{client.dni}}</strong></p>
                                        <p><span>Domicilio Laboral: </span><strong class="text-warning">{{client.job_address}}</strong></p>
                                        <p><span>Correo: </span><strong class="text-warning">{{client.email}}</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="swiper-slide" style="height: auto;">
                            <div class="card bg-primary text-white">
                                <h5 class="title pt-3 text-center"><i class="fas fa-id-card text-warning"></i> Datos Personales</h5>
                                <div class="d-flex justify-content-around">
                                    <div class="px-2">
                                        <p><span>Domicilio: </span><strong class="text-warning">{{client.address}}</strong></p>
                                        <p><span>Estado civil: </span><strong class="text-warning">{{client.get_civil_status_display}}</strong></p>
                                        <p><span>Profesion: </span><strong class="text-warning">{{client.profession}}</strong></p>
                                    </div>
                                    <div>
                                        <p><span>DNI: </span><strong class="text-warning">{{client.dni}}</strong></p>
                                        <p><span>Domicilio Laboral: </span><strong class="text-warning">{{client.job_address}}</strong></p>
                                        <p><span>Correo: </span><strong class="text-warning">{{client.email}}</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 col-12 p-3">
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 col-12 p-3">
                <div class="card bg-primary text-white media p-4">
                    <h5 class="title py-3">Registro</h5>
                    <p class="m-0">Asesor Financiero</p>
                    <p><a class="text-warning" href="{% url 'advisers:detail' client.adviser.pk %}"><strong>{{client.adviser}}</strong></a></p>
                    <p class="m-0">Fecha de Entrada al sistema</p>
                    <p><strong>{{client.created_at|date}}</strong></p>
                    <h5 class="title pt-3">Creditos</h5>
                    {% if credits %}
                    <p>Cantidad de Creditos </p>
                    <p>Tiene un credito activo</p>
                    {% else %}
                    <p>No se registraron Creditos</p>
                    {% endif %}
                </div>
            </div>

            {% if credits_active %}
            <div class="col-xl-9 col-sm-6 col-12 p-3">
                <!-- DICCIONARIO PARA RECORRER COMPLETAMENTE LOS CREDITOS Y FORMULARIOS (PAGOS Y REF.) , CUOTAS Y FORMULARIOS DE PAGO DE REF.-->
                <!-- credit_active = credito actual | form_payment ( _.0 = formulario de pago - _.1 = formulario de refinanciacion) -->
                {% for credit_active, form_payment in client_payment.items %}
                <div class="card box-shadow mt-2 plegable-card" data-card-id="{{ credit_active.id }}">
                    <div class="title-card d-flex p-3 align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="led-success"></div>
                            <h5 class="title pl-3 m-0">Credito activo</h5>
                        </div>
                        <button data-card-id="{{ credit_active.id }}" class="toggle-card btn btn-sm btn-white"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="card-body">
                        <div class="col-12 col-md-5 mt-4">
                            <div class="row align-items-center">
                                <div class="col p-0">
                                    <span>Monto solicitado:</span>
                                </div>
                                <div class="col p-0">
                                    <span class="font-weight-bold" style="font-size: 1.2rem;">${{credit_active.amount}}</span>
                                </div>
                            </div>
                            <div class="row align-items-center">
                                <div class="col p-0">
                                    <span>Monto a devolver:</span>
                                </div>
                                <div class="col p-0">
                                    <span class="font-weight-bold" style="font-size: 1.2rem;">$ {{credit_active.credit_repayment_amount}}</span>
                                </div>
                            </div>
                            <div class="row align-items-center">
                                <div class="col p-0">
                                    <span>Cuotas:</span>
                                </div>
                                <div class="col p-0">
                                    <span class="font-weight-bold" style="font-size: 1.2rem;">{{credit_active.installment_num}}</span>
                                </div>
                            </div>
                            <div class="row align-items-center">
                                <div class="col-12 p-0">
                                    <div class="form-group">
                                        <!-- BOTON MODAL PARA PAGOS DE CUOTAS -->
                                        {% if installments_available %} {% with form_payment.0 as form_payment %}
                                        <!-- .0 para formulario de refinanciacion -->
                                        {% include "payment/payment_form.html" %} {% endwith %} {% endif %} {% if credit_active.installments.first.is_paid_installment %}
                                        <div type="button" class="btn btn-primary p-3" data-toggle="modal" data-target="#Refinancing{{credit_active.pk}}">
                                            <i class="fas fa-sync-alt text-info"></i>
                                            <span onclick="get_id(`{{credit_active.pk}}`)">Refinanciar</span>
                                        </div>
                                        <!--Modal de refinanciacion-->
                                        <div class="modal fade" id="Refinancing{{credit_active.pk}}" tabindex="-1" role="dialog" aria-labelledby="Refinancing{{credit_active.pk}}" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content bg-primary text-white">
                                                    <form action="{% url 'credits:refinance' credit_active.pk %}" method="POST">
                                                        <div class="modal-header">
                                                            <h4 class="modal-title" id="exampleModalLabel">Refinanciacion de Cuotas</h4>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            {% csrf_token %} {% with form_payment.1 as form_refinance %}
                                                            <!-- .1 para formulario de refinanciacion -->
                                                            {{form_refinance.as_p}} {% endwith %}
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-success">Refinanciar</button>
                                                            <button type="button" class="btn btn-info" data-dismiss="modal">Cerrar</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-lg-responsive table-striped table-hover">
                            <thead class="table-primary text-white">
                                <tr>
                                    <th scope="col"><i class="fas fa-coins text-warning"></i> Cuota</th>
                                    <th scope="col"><i class="fas fa-dollar-sign text-warning"></i> Monto</th>
                                    <th scope="col"><i class="fas fa-calendar-alt text-warning"></i> Vencimiento</th>
                                    <th scope="col"><i class="fas fa-check-circle text-warning"></i> Estado</th>

                                    {% if installments_available %}
                                    <th scope="col"><i class="fas fa-cog text-warning"></i> Acciones</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for installments in form_payment.2 %} {% with installments.0 as installment %}
                                <tr class="{% if installment.condition == 'A Tiempo' %}alert alert-warning{% elif installment.is_caduced_installment %}alert alert-danger{% elif installment.is_paid_installment and installment.is_refinancing_installment %}alert alert-info{% elif installment.is_refinancing_installment %}alert alert-info{% else %}alert alert-success{% endif %}">
                                    <td>{{installment.installment_number}}</td>
                                    <td><strong>$ {{installment.amount}}</strong></td>
                                    <td>{{installment.end_date|date}}</td>
                                    <td>
                                        {% if installment.is_paid_installment %}
                                        <strong><i class="fas fa-check text-success"></i></strong> {% elif installment.condition == 'A Tiempo' %}
                                        <strong><i class="fas fa-clock text-warning"></i></strong> {% elif installment.is_caduced_installment %}
                                        <strong><i class="fas fa-exclamation-triangle text-danger"></i></strong> {% elif installment.is_paid_installment and installment.is_refinancing_installment %}
                                        <a href="{% url 'credits:refinance_detail' installment.pk %}"><strong><i class="fas fa-sync-alt text-info"></i></strong></a> {% elif installments.1.0 %}
                                        <a data-toggle="collapse" href="#collapseRefinancing-{{ installment.pk }}" role="button" aria-expanded="false" aria-controls="collapseRefinancing-{{ installment.pk }}"><strong><i class="fas fa-sync-alt text-info"></i></strong></a>                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'credits:installment_update' installment.pk %}"><i class="fas fa-edit"></i></a>
                                    </td>
                                </tr>
                                {% if installments.1.0 %}
                                <tr class="collapse" id="collapseRefinancing-{{ installment.pk }}">
                                    <td class="px-3" colspan="5">
                                        <table class="table table-responsive-lg">
                                            <thead class="table text-white">
                                                <h5 class="card-title text-center animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-sync text-info"></i>&nbsp;{{installments.1.0}}</h5>
                                            </thead>
                                            <tbody>
                                                <!-- installments.0 es la cuota // installments.1 es la una lista que contiene la refinanciacion (_.1.0)(refinanciacion) y el formulario de pago de dicha refinanciacion (_.1.1)(formulario de pago) -->

                                                {% with installments.1.0 as refinancing_table %} {% with installments.1.1 as form_payment %}
                                                <!-- BOTON PARA PAGAR REFINANCIACION // cambio nombre porque en el html de payment esta asi: form_payment -->
                                                {% with refinancing_table as credit_active %}
                                                <!-- cambio nombre porque en el html de payment esta asi: credit_active -->
                                                <div class="p-3 d-flex justify-content-center">
                                                    {% include "payment/payment_form.html" %}
                                                </div>
                                                {% endwith %} {% endwith %} {% for installment_ref in refinancing_table.installments.all %}
                                                <tr class="{% if installment_ref.condition == 'A Tiempo' %}alert alert-warning{% elif installment_ref.is_caduced_installment %}alert alert-danger{% elif installment_ref.is_paid_installment and installment_ref.is_refinancing_installment %}alert alert-info{% elif installment_ref.is_refinancing_installment %}alert alert-info{% else %}alert alert-success{% endif %}">
                                                    <td>{{installment_ref.installment_number}}</td>
                                                    <td><strong>$ {{installment_ref.amount}}</strong></td>
                                                    <td>{{installment_ref.end_date|date}}</td>
                                                    <td>
                                                        {% if installment_ref.condition == 'A Tiempo' %}
                                                        <strong><i class="fas fa-clock text-warning"></i></strong> {% elif installment_ref.is_caduced_installment %}
                                                        <strong><i class="fas fa-exclamation-triangle text-danger"></i></strong> {% else %}
                                                        <strong><i class="fas fa-check text-success"></i></strong> {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'credits:installmentRef_update' installment_ref.pk %}"><i class="fas fa-edit"></i></a>
                                                    </td>
                                                </tr>
                                                {% endfor %} {% endwith %}
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                {% endif %} {% endwith %} {% endfor %}
                            </tbody>
                        </table>
                        <div class="card-footer p-1 bg-primary rounded-bottom"></div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="col-xl-9 col-sm-6 col-12 p-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <div id="title-card" class="d-flex p-0 m-0 align-items-center">
                                <div class="led-danger"></div>
                                <h5 class="title pl-3 m-0">Sin creditos activos</h5>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
            <div class="row mb-4">
                <div class="col-xl-3 col-sm-6 col-12 p-3">
                </div>
            </div>
    </section>
</main>
<script type="module">
    import Swiper from 'https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.esm.browser.min.js';
</script>

<!--Swipper DataClient-->
<script>
    var swiper = new Swiper(".SwiperData", {
        effect: 'flip',
        flipEffect: {
            slideShadows: false,
        },
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        coverflowEffect: {
            rotate: 50,
            stretch: 0,
            depth: 100,
            modifier: 1,
            slideShadows: true,
        },
        autoplay: {
            delay: 2100,
            disableOnInteraction: false,
        },
    });
</script>
</script>
<!--Swipper StateClient-->
<script>
    var swiper = new Swiper(".SwiperCards", {
        effect: "coverflow",
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        coverflowEffect: {
            rotate: 50,
            stretch: 0,
            depth: 100,
            modifier: 1,
            slideShadows: true,
        },
        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
            type: 'bullets',
        },
    });
</script>

<script>
    function get_id(id) { // CAPTO ID DEL CREDITO PARA LA MANIPULACION DE PAGOS DE SUS CUOTAS
        var id = id;

        const checkboxes = document.querySelectorAll('input[type="checkbox"][data-form-id="form_ref' + id + '"]'); //AGREGO ID PARA SABER EXACTAMENTE QUE DE QUE CHECKBOXES SE TRATAN
        const selector = document.querySelector('#id_installment_num_refinancing' + id); // ID PARA EL SELECTOR EN CASO DE TENER MUCHOS CREDITOS A REFIANNCIAR
        const sumElement = document.querySelector('#id_amount' + id); // ID PARA VER EL MONTO FINAL EN CASO DE QUERER REFIANNCIAR
        const refInstallmentDetail = document.getElementById('ref-installment-detail');
        const refInstallmentAmount = document.createElement('span');
        let porcentaje;

        refInstallmentAmount.classList.add('text-warning', 'font-weight-bold')
        refInstallmentAmount.style.fontSize = '1.5rem';

        function calcularSuma() {
            let sum = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    sum += parseFloat(checkbox.value);
                }
            });

            switch (parseInt(selector.value)) {
                case 3:
                    porcentaje = 25;
                    break;
                case 6:
                    porcentaje = 50;
                    break;
                case 9:
                    porcentaje = 75;
                    break;
                default:
                    porcentaje = 100;
                    break;
            }
            const selectorValue = parseFloat(selector.value);
            const total = (sum * (porcentaje + 100) / 100).toFixed(2);
            sumElement.value = `${total}`;
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', calcularSuma);
        });
        if (selector !== null) {
            selector.addEventListener('change', calcularSuma);
        }
    }
</script>
<script>
    const ledSuccess = document.querySelector('.led-success');
    const ledDanger = document.querySelector('.led-danger');
    const ledWarning = document.querySelector('.led-warning');
    let led;

    if (ledSuccess != null) {
        led = ledSuccess
    } else if (ledDanger != null) {
        led = ledDanger
    } else {
        led = ledWarning
    }

    function blink(led) {
        led.classList.toggle('blink');
    }

    setInterval(() => {
        blink(led);
    }, 1500);
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const toggleCardButtons = document.querySelectorAll(".toggle-card");
        toggleCardButtons.forEach(function(toggleCardButton) {
            if (toggleCardButtons != null) {
                toggleCardButton.addEventListener("click", function() {
                    const cardId = toggleCardButton.getAttribute("data-card-id");
                    const cardContent = document.querySelector(`.plegable-card[data-card-id="${cardId}"] .card-body`);

                    if (cardContent.style.display === "none") {
                        cardContent.style.display = "block";
                        toggleCardButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    } else {
                        cardContent.style.display = "none";
                        toggleCardButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    }
                });
            }
        });
    });
</script>
{% endblock content %}