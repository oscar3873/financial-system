{% extends "core/base.html" %} {% block content %} {% load static %}
<!--Main-->
<link href="{% static 'clients/css/client_detail.css' %}" rel="stylesheet"> 

{% if client.is_legals %}
<div class="alert alert-danger text-center" role="alert">
    <h1 class="font-weight-bold">CLIENTE: {{client.first_name|upper}} {{client.last_name|upper}} <br> EN LEGALES</h1>
</div>
{% if user.is_superuser %}
<!-- BOTON MODAL -->
<div>
    <button class="btn btn-danger" value="false" name="go_legals" id="id_remove_legal_status" data-toggle="modal" data-target="#Legals_remove">Quitar estado legal</button>
</div>
<!-- MODAL -->
<div class="modal fade" id="Legals_remove" tabindex="-1" role="dialog" aria-labelledby="Legals_remove" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content bg-primary text-white">
            <form action="{% url 'clients:legals' client.pk %}" method="POST">
                <div class="modal-header">
                    <h4 class="modal-title" id="Legals_remove">Remover el estado legal</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                </div>
                <div class="modal-body">
                    ¿Esta seguro de quitar estado legal?
                </div>
                <div class="modal-footer">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Quitar</button>
                    <button type="btn" class="btn btn-info" data-dismiss="modal">Cerrar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %} {% else %}

<main class="container my-4">
    {% include 'core/message.html' %}
    <a href="{% url 'clients:update' client.pk %}">
        <h4 class="title font-weight-normal animate__fadeInLeft" style="animation-duration: 0.5s !important;">
            <i class="fa fa-wrench text-warning" aria-hidden="true"></i>
            {{client.first_name}} {{client.last_name}}
        </h4>
    </a>
    {% if user.is_superuser %}
    <button class="btn btn-danger" data-toggle="modal" data-target="#Legals" onclick="go_legals()">
        <i class="fa fa-bell text-white"></i>
        <span>Legal</span>
    </button> {% endif %}
    <div class="modal fade" id="Legals" tabindex="-1" role="dialog" aria-labelledby="Legals" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-primary text-white">
                <form action="{% url 'clients:legals' client.pk %}" method="POST">
                    <div class="modal-header">
                        <h4 class="modal-title" id="Legals">Derivar a departamento legal</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                    </div>
                    <div class="modal-body">
                        ¿Esta seguro de Iniciar procedimientos legales?
                    </div>
                    <div class="modal-footer">
                        {% csrf_token %}
                        <button type="button" class="btn btn-info" data-dismiss="modal">Cerrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <section>
        <div class="row justify-content-center">
            <div class="col-xl-3 col-sm-3 col-12 p-3">
                <!-- Swiper -->
                <div class="swiper SwiperCards">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <div class="card bg-primary box-shadow text-white">
                                <div class="card-body">
                                    <h5 class="card-title animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-trophy text-warning"></i>&nbsp;Score</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="text-warning font-weight-bold">{{client.score_label}}</p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-around align-items-center">
                                        {% if client.score_label == "Exelente" or client.score_label == "Muy Bueno" %}
                                        <div class="led-success"></div>
                                        {% elif client.score_label == "Bueno" %}
                                        <div class="led-warning"></div>
                                        {% else %}
                                        <div class="led-danger"></div>
                                        {% endif %}

                                        <span class="text-white font-weight-bold" style="font-size: 2rem">{{client.score}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="card bg-primary box-shadow text-white">
                                <div class="card-body">
                                    <h5 class="card-title animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-trophy text-warning"></i>&nbsp;Score</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="text-warning font-weight-bold">{{client.score_label}}</p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-around align-items-center">
                                        {% if client.score_label == "Exelente" or client.score_label == "Muy Bueno" %}
                                        <div class="led-success"></div>
                                        {% elif client.score_label == "Bueno" %}
                                        <div class="led-warning"></div>
                                        {% else %}
                                        <div class="led-danger"></div>
                                        {% endif %}

                                        <span class="text-white" style="font-size: 2rem">{{client.score}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
                <div class="card bg-primary my-2 border-0 text-white box-shadow ">
                    <a name="" id="" class="btn btn-secondary rounded p-3" href="{% url 'credits:associate_credit_for_customer' client.pk %}" role="button">
                        <i class="fa fa-plus-circle" aria-hidden="true"></i>
                        <span>Agregar nuevo credito</span>
                    </a>
                </div>
                <div class="card bg-primary text-white media p-4">
                    <h5 class="title py-3"><i class="fas fa-user-edit text-warning"></i> Registro</h5>
                    <p class="m-0">Asesor Financiero</p>
                    <p><a class="text-warning" href="{% url 'advisers:detail' client.adviser.pk %}">
                        {% if client.adviser.avatar %}
                        <img src="{{client.adviser.avatar.url}}" width="50px" height="50px" class="  rounded-circle"> {% else %}
                        <img src="/media/{{MEDIA_URL}}avatares/default.png" width="50px" height="50px" alt="avatar" class="rounded-circle p-2  "> {% endif %}
                    </a></p>
                    <p class="m-0">Fecha de Entrada al sistema</p>
                    <p><strong>{{client.created_at|date}}</strong></p>
                    <h5 class="title pt-3">Creditos</h5>
                    {% if credits %}
                    <p>Creditos solicitados <span class="font-weight-bold text-warning">{{count_credits}}</span></p>
                    <p>Creditos activo <span class="font-weight-bold text-warning">{{count_credits_active}}</span></p>
                    {% else %}
                    <p>No se registraron Creditos</p>
                    {% endif %}
                </div>
            </div>
            <div class="col-xl-9 col-sm-9 col-12">
                <div class="row justify-content-center">
                    <div class="col-12 col-md-6">
                        <!-- Swiper -->
                        <div class="swiper SwiperData">
                            <div class="swiper-wrapper">
                                <div class="swiper-slide" style="height: auto;">
                                    <div class="card bg-primary text-white">
                                        <h5 class="title pt-3 text-center"><i class="fas fa-id-card text-warning"></i> Datos Personales</h5>
                                        <div class="d-flex justify-content-around">
                                            <div class="px-2">
                                                <p><span>Domicilio: </span><strong class="text-warning">{{client.address}}</strong></p>
                                                <p><span>Estado civil: </span><strong class="text-warning">{{client.get_civil_status_display}}</strong></p>
                                                <p><span>Profesion: </span><strong class="text-warning">{{client.profession}}</strong></p>
                                            </div>
                                            <div>
                                                <p><span>DNI: </span><strong class="text-warning">{{client.dni}}</strong></p>
                                                <p><span>Domicilio Laboral: </span><strong class="text-warning">{{client.job_address}}</strong></p>
                                                <p><span>Correo: </span><strong class="text-warning">{{client.email}}</strong></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="swiper-slide" style="height: auto;">
                                    <div class="card bg-primary text-white">
                                        <h5 class="title pt-3 text-center"><i class="fas fa-id-card text-warning"></i> Datos Personales</h5>
                                        <div class="d-flex justify-content-around">
                                            <div class="px-2">
                                                <p><span>Domicilio: </span><strong class="text-warning">{{client.address}}</strong></p>
                                                <p><span>Estado civil: </span><strong class="text-warning">{{client.get_civil_status_display}}</strong></p>
                                                <p><span>Profesion: </span><strong class="text-warning">{{client.profession}}</strong></p>
                                            </div>
                                            <div>
                                                <p><span>DNI: </span><strong class="text-warning">{{client.dni}}</strong></p>
                                                <p><span>Domicilio Laboral: </span><strong class="text-warning">{{client.job_address}}</strong></p>
                                                <p><span>Correo: </span><strong class="text-warning">{{client.email}}</strong></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </div>
                    <div class="col-8 col-md-6 mt-lg-0 mt-3 mb-3">
                        {% if next_three_installments %}
                        <!-- Swiper -->
                        <div class="swiper SwiperExpiration">
                            <div class="swiper-wrapper">
                                {% for installment in next_three_installments %}
                                <div class="swiper-slide" style="height: auto; overflow: hidden;">
                                    <div class="card bg-primary text-white" style="overflow: hidden;">
                                        <div class="card-body">
                                            <h5 class="title text-center">
                                                <i class="fas fa-hourglass-half text-warning"></i> Proximos Vencimientos
                                            </h5>
                                            <p class="text-center" style="font-size: 1.1rem;">Cuota <span class="text-warning font-weight-bold" style="font-size: 1.1rem;">{{installment.installment_number}}</span></p>
                                            <p>Fecha: <span class="text-warning font-weight-bold"> {{ installment.end_date|date}}</span></p>
                                            <p>Monto: <span class="text-warning font-weight-bold"> $ {{ installment.amount }}</span></p>

                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-pagination"></div>
                        </div>
                        {% else %}
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="title text-center">
                                    Sin proximos vencimientos
                                </h5>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if credits_active %}
                <!-- DICCIONARIO PARA RECORRER COMPLETAMENTE LOS CREDITOS Y FORMULARIOS (PAGOS Y REF.) , CUOTAS Y FORMULARIOS DE PAGO DE REF.-->
                <!-- credit_active = credito actual | form_payment ( _.0 = formulario de pago - _.1 = formulario de refinanciacion) -->
                {% for credit_active, form_payment in client_payment.items %}
                <div class="card box-shadow mt-2 plegable-card" data-card-id="{{ credit_active.id }}">
                    <div class="title-card d-flex p-3 align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="led-success"></div>
                            <h5 class="title pl-3 m-0">Credito activo</h5>
                            <div class="ml-3"> <a href="{% url 'credits:edit_credit' credit_active.id %}"><i class="fa fa-edit"></i></a></div>
                        </div>
                        <button data-card-id="{{ credit_active.id }}" class="toggle-card btn btn-sm btn-white"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="card-body">
                        <div class="row px-2 justify-content-center">
                            <div class="col-12 col-md-5">
                                 <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span>Asesor:</span>
                                    </div>
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">{{credit_active.adviser}}</span>
                                    </div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span>Monto solicitado:</span>
                                    </div>
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">${{credit_active.amount}}</span>
                                    </div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span>Monto a devolver:</span>
                                    </div>
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">$ {{credit_active.credit_repayment_amount}}</span>
                                    </div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span>Cuotas:</span>
                                    </div>
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">{{credit_active.installment_num}}</span>
                                    </div>
                                </div>
                                
                                {% if credit_active.guarantor %}
                                <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span>Garante:</span>
                                    </div>
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">{{credit_active.guarantor}}</span>
                                    </div>
                                </div>
                                {% endif %}

                                {% if credit_active.has_pay_stub %}
                                <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">PRESENTO RECIBO DE SUELDO</span>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if credit_active.warranty_client.first %}
                                <div class="row align-items-center">
                                    <div class="col p-0">
                                        <span>Empeño:</span>
                                    </div>
                                    <div class="col p-0">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">{{credit_active.warranty_client.first}}</span>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="row align-items-center justify-content-center">
                                    <div class="col-12 p-0">
                                        <div class="form-group">
                                            <!-- BOTON MODAL PARA PAGOS DE CUOTAS -->
                                            {% if form_payment %} 
                                                {% with form_payment.0 as form_payment %}
                                                    <!-- .0 para formulario de refinanciacion -->
                                                    {% include "payment/payment_form.html" %} 
                                                {% endwith %}
                                            {% endif %} 

                                            {% if credit_active.installments.first.is_paid_installment and form_payment.1 %}
                                            <button type="button" class="btn btn-primary p-3" data-toggle="modal" data-target="#Refinancing{{credit_active.pk}}" data-id="{{credit_active.pk}}" id="refinancingButton{{credit_active.pk}}">
                                                <i class="fas fa-sync-alt text-info"></i> Refinanciar
                                            </button>

                                            <!--Modal de refinanciacion-->
                                            <div class="modal fade" id="Refinancing{{credit_active.pk}}" tabindex="-1" role="dialog" aria-labelledby="Refinancing{{credit_active.pk}}" aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content bg-primary text-white">
                                                        <form action="{% url 'credits:refinance' credit_active.pk %}" method="POST">
                                                            <div class="modal-header">
                                                                <h4 class="modal-title" id="exampleModalLabel">Refinanciacion de Cuotas</h4>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                        <span aria-hidden="true">&times;</span>
                                                                    </button>
                                                            </div>
                                                            <style>
                                                                .form-check-label {
                                                                    margin-bottom: 0;
                                                                }
                                                                
                                                                .form-check-input {
                                                                    margin-top: 0.5rem;
                                                                }
                                                            </style>

                                                            <div class="modal-body">
                                                                {% csrf_token %} {% with form_payment.1 as form_refinance %}
                                                                <!-- .1 para formulario de refinanciacion -->
                                                                <div class="row">
                                                                    <div class="col-6">
                                                                        <i class="fas fa-dollar-sign"></i> {{form_refinance.amount.label_tag}} {{form_refinance.amount}}
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <i class="fas fa-coins"></i> {{form_refinance.installment_amount.label_tag}} {{form_refinance.installment_amount}}
                                                                    </div>
                                                                </div>
                                                                <div class="row mt-3">
                                                                    <div class="col-12">
                                                                        <i class="fas fa-list-ol"></i> {{form_refinance.installment_num.label_tag}} {{form_refinance.installment_num}}
                                                                    </div>
                                                                </div>
                                                                <div class="row mt-3">
                                                                    <div class="col-12">
                                                                        <i class="fas fa-sync-alt"></i>
                                                                        <span>Cuotas a refinanciar:</span>
                                                                        <div class="d-flex flex-wrap align-items-center">
                                                                            {% for field in form_refinance %} {% if "cuota" in field.html_name %}
                                                                            <div class="form-check form-check-inline m-2">
                                                                                <label class="form-check-label" for="{{field.auto_id}}">{{field.label}}</label>&nbsp;{{field}}
                                                                            </div>
                                                                            {% endif %} {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% endwith %}
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button class="btn btn-success"><i class="fas fa-sync-alt"></i> Refinanciar</button>
                                                                <button type="button" class="btn btn-info" data-dismiss="modal"><i class="fas fa-times"></i> Cerrar</button>
                                                            </div>

                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-8 col-md-6">
                                <!-- Swiper -->
                                <div class="swiper SwiperExpiration">
                                    <div class="swiper-wrapper">
                                        {% for last_three_payments in last_three_payments_by_credit_list %} {% for payment in last_three_payments %}
                                        <div class="swiper-slide" style="height: auto; overflow: hidden;">
                                            <div class="card bg-primary text-white box-shadow" style="overflow: hidden;">
                                                <div class="card-body">
                                                    <h5 class="title text-center">
                                                        <i class="fas fa-check text-warning"></i> Ultimos pagos
                                                    </h5>

                                                    {% if payment.installment %}
                                                    <p class="text-center"><span>{{payment.installment}}</span></p>
                                                    {% else %}
                                                    <p class="text-center"><span>{{payment.installment_ref}}</span></p>
                                                    {% endif %}
                                                    <p>Pagado el <span class=" font-weight-bold text-warning">{{ payment.payment_date }}</span></p>
                                                    <p>Monto: <span class=" font-weight-bold text-warning"> $ {{ payment.amount }}</span></p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %} {% endfor %}
                                    </div>
                                    <div class="swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-responsive-lg table-striped table-hover">
                            <thead class="table-primary text-white">
                                <tr>
                                    <th scope="col"><i class="fas fa-coins text-warning"></i> Cuota</th>
                                    <th scope="col"><i class="fas fa-dollar-sign text-warning"></i> Monto</th>
                                    <th scope="col"><i class="fas fa-calendar-alt text-warning"></i> Vencimiento</th>
                                    <th scope="col"><i class="fas fa-tasks text-warning"></i> Estado</th>
                                    <th scope="col"><i class="fas fa-cog text-warning"></i> Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for installments in form_payment.2 %} {% with installments.0 as installment %}
                                <tr class="{% if installment.condition == 'A Tiempo' %}alert alert-warning{% elif installment.is_caduced_installment %}alert alert-danger{% elif installment.is_paid_installment and installment.is_refinancing_installment %}alert alert-info{% elif installment.is_refinancing_installment %}alert alert-info{% else %}alert alert-success{% endif %}">
                                    <td>{{installment.installment_number}}</td>
                                    <td><strong>$ {{installment.amount}}</strong></td>
                                    <td>{{installment.end_date|date}}</td>
                                    <td>
                                        {% if installment.is_paid_installment %}
                                        <strong><i class="fas fa-check text-success"></i></strong> {% elif installment.condition == 'A Tiempo' %}
                                        <strong><i class="fas fa-clock text-warning"></i></strong> {% elif installment.is_caduced_installment %}
                                        <strong><i class="fas fa-exclamation-triangle text-danger"></i></strong> {% elif installment.is_paid_installment and installment.is_refinancing_installment %}
                                        <a href="{% url 'credits:refinance_detail' installment.pk %}"><strong><i class="fas fa-sync-alt text-info"></i></strong></a> {% elif installments.1.0 %}
                                        <a data-toggle="collapse" href="#collapseRefinancing-{{ installment.pk }}" role="button" aria-expanded="false" aria-controls="collapseRefinancing-{{ installment.pk }}"><strong><i class="fas fa-sync-alt text-info"></i></strong></a>                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'credits:installment_update' installment.pk %}"><i class="fas fa-edit"></i></a>
                                    </td>
                                </tr>
                                {% if installments.1.0 %}
                                <tr class="collapse" id="collapseRefinancing-{{ installment.pk }}">
                                    <td class="px-3" colspan="5">
                                        <table class="table table-responsive-lg table-striped table-hover">
                                            <thead class="table text-white">
                                                <div class="form-group">
                                                    {% with installments.1.0 as refinancing_table %}
                                                    <h5 class="card-title text-center animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-sync text-info"></i>&nbsp;{{refinancing_table.resumen_str_}}
                                                        <i class="fas fa-trash-alt text-danger btn mr-3 ml-3" data-toggle="modal" data-target="#DeleteRefinancing{{refinancing_table.pk}}"></i>
                                                        <a href="{% url 'credits:refinance_update' refinancing_table.pk %}"><i class="fas fa-edit" ></i></a>
                                                    </h5>
                                                </div>
                                            </thead>
                                            <tbody>
                                                <!-- installments.0 es la cuota // installments.1 es la una lista que contiene la refinanciacion (_.1.0)(refinanciacion) y el formulario de pago de dicha refinanciacion (_.1.1)(formulario de pago) -->


                                                <!--Modal de refinanciacion-->
                                                <div class="modal fade" id="DeleteRefinancing{{refinancing_table.pk}}" tabindex="-1" role="dialog" aria-labelledby="DeleteRefinancing{{refinancing_table.pk}}" aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content bg-primary text-white">
                                                            <form action="{% url 'credits:refinance_delete' refinancing_table.pk %}" method="POST">
                                                                <div class="modal-header">
                                                                    <h4 class="modal-title" id="DeleteRefinancing">Eliminacion de {{refinancing_table.resumen_str_}}</h4>
                                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    {% csrf_token %}
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button class="btn btn-success">Refinanciar</button>
                                                                    <button type="button" class="btn btn-info" data-dismiss="modal">Cerrar</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- BOTON PARA PAGAR REFINANCIACION // cambio nombre porque en el html de payment esta asi: form_payment -->
                                                {% with installments.1.1 as form_payment %}
                                                    {% with refinancing_table as credit_active %}
                                                        <!-- cambio nombre porque en el html de payment esta asi: credit_active -->
                                                        <div class="p-3 d-flex justify-content-center">
                                                            {% include "payment/payment_form.html" %}
                                                        </div>
                                                    {% endwith %} 
                                                {% endwith %} 
                                                {% for installment_ref in refinancing_table.installments.all %}
                                                <tr class="{% if installment_ref.condition == 'A Tiempo' %}alert alert-warning{% elif installment_ref.is_caduced_installment %}alert alert-danger{% elif installment_ref.is_paid_installment and installment_ref.is_refinancing_installment %}alert alert-info{% elif installment_ref.is_refinancing_installment %}alert alert-info{% else %}alert alert-success{% endif %}">
                                                    <td>{{installment_ref.installment_number}}</td>
                                                    <td><strong>$ {{installment_ref.amount}}</strong></td>
                                                    <td>{{installment_ref.end_date|date}}</td>
                                                    <td>
                                                        {% if installment_ref.condition == 'A Tiempo' %}
                                                        <strong><i class="fas fa-clock text-warning"></i></strong> {% elif installment_ref.is_caduced_installment %}
                                                        <strong><i class="fas fa-exclamation-triangle text-danger"></i></strong> {% else %}
                                                        <strong><i class="fas fa-check text-success"></i></strong> {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'credits:installmentRef_update' installment_ref.pk %}"><i class="fas fa-edit"></i></a>
                                                    </td>
                                                </tr>
                                                {% endfor %} {% endwith %}
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                {% endif %} {% endwith %} {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %} {% else %}
                <div class="card plegable-card mt-2">
                    <div class="card-body">
                        <div id="title-card" class="d-flex p-0 m-0 align-items-center">
                            <div class="led-danger"></div>
                            <h5 class="title pl-3 m-0">Sin creditos activos</h5>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class=" justify-content-center">
            <div class="col-12">
                <div class="card box-shadow mt-2">
                    <div class="card-body">
                        <h4 class="card-title"><i class="fas fa-history"></i> Historial</h4>
                        {% include 'credit/includes/credit_table.html' %}
                    </div>
                </div>
            </div>
        </div>

    </section>
</main>
{% endif %}
<script type="module">
    import Swiper from 'https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.esm.browser.min.js';
</script>
<!--Swipper ExpirationData-->
<script>
    var swiper = new Swiper(".SwiperExpiration", {
        effect: "cards",
        pagination: {
            el: ".swiper-pagination",
            dynamicBullets: true,
        },
    });
</script>
<!--Swipper PaymentData-->
<script>
    var swiper = new Swiper(".SwiperPayment", {
        effect: "cards",
        pagination: {
            el: ".swiper-pagination",
            dynamicBullets: true,
        },
    });
</script>
<!--Swipper ClientData-->
<script>
    var swiper = new Swiper(".SwiperData", {
        effect: 'flip',
        flipEffect: {
            slideShadows: false,
        },
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        coverflowEffect: {
            rotate: 50,
            stretch: 0,
            depth: 100,
            modifier: 1,
            slideShadows: true,
        },
        autoplay: {
            delay: 2100,
            disableOnInteraction: false,
        },
    });
</script>
</script>
<!--Swipper StateClient-->
<script>
    var swiper = new Swiper(".SwiperCards", {
        effect: "coverflow",
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        coverflowEffect: {
            rotate: 50,
            stretch: 0,
            depth: 100,
            modifier: 1,
            slideShadows: true,
        },
        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
            type: 'bullets',
        },
    });
</script>

<script>
    function go_legals() {
        var modalFooter = document.querySelector('.modal-footer');
        var existingButton = document.querySelector('#id_go_legals');

        if (!existingButton) {
            var newButton = document.createElement('button');
            newButton.classList.add('btn', 'btn-danger');
            newButton.innerHTML = 'LEGAL';
            newButton.value = true;
            newButton.name = 'go_legals';
            newButton.id = 'id_go_legals';
            modalFooter.insertBefore(newButton, modalFooter.firstChild);
        }
    }
</script>
<!--Refinancia las cuotas seleccionadas-->
<script>
    const get_id = (id) => {
        const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-form-id="form_ref${id}"]`);
        const selector = document.querySelector(`#id_installment_num${id}`);
        const installment_value = document.querySelector(`#id_installment_amount${id}`);
        const sumElement = document.querySelector(`#id_amount${id}`);
        const refInstallmentDetail = document.getElementById('ref-installment-detail');
        const refInstallmentAmount = document.createElement('span');
        let porcentaje;

        refInstallmentAmount.classList.add('text-warning', 'font-weight-bold');
        refInstallmentAmount.style.fontSize = '1.5rem';

        const round_to_nearest_hundred = (x) => {
            return x % 100 >= 50 ? (Math.floor(x / 100) + 1) * 100 : Math.floor(x / 100) * 100;
        };

        const calcularSuma = () => {
            let sum = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    sum += parseFloat(checkbox.value);
                }
            });

            switch (parseInt(selector.value)) {
                case 3:
                    porcentaje = 25;
                    break;
                case 6:
                    porcentaje = 50;
                    break;
                case 9:
                    porcentaje = 75;
                    break;
                default:
                    porcentaje = 100;
                    break;
            }
            const selectorValue = parseFloat(selector.value);
            const subtotal = round_to_nearest_hundred((sum * (porcentaje + 100) / 100).toFixed(2));
            const installment_amount = round_to_nearest_hundred((subtotal / selectorValue).toFixed(2));
            const total = installment_amount * selectorValue;

            sumElement.value = `${total}`;
            installment_value.value = `${installment_amount}`;
        };

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', calcularSuma);
        });
        if (selector !== null) {
            selector.addEventListener('change', calcularSuma);
        }
    };
    document.addEventListener("DOMContentLoaded", () => {
        const refinancingButtons = document.querySelectorAll('[data-id]');

        refinancingButtons.forEach((refinancingButton) => {
            refinancingButton.addEventListener("click", () => {
                const id = refinancingButton.getAttribute('data-id');
                get_id(id);
                console.log("Entre aqui");
            });
        });
    });
</script>

<script>
    const ledSuccess = document.querySelector('.led-success');
    const ledDanger = document.querySelector('.led-danger');
    const ledWarning = document.querySelector('.led-warning');
    let led;

    if (ledSuccess != null) {
        led = ledSuccess
    } else if (ledDanger != null) {
        led = ledDanger
    } else {
        led = ledWarning
    }

    function blink(led) {
        led.classList.toggle('blink');
    }

    setInterval(() => {
        blink(led);
    }, 1500);
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const toggleCardButtons = document.querySelectorAll(".toggle-card");
        toggleCardButtons.forEach(function(toggleCardButton) {
            if (toggleCardButtons != null) {
                toggleCardButton.addEventListener("click", function() {
                    const cardId = toggleCardButton.getAttribute("data-card-id");
                    const cardContent = document.querySelector(`.plegable-card[data-card-id="${cardId}"] .card-body`);

                    if (cardContent.style.display === "none") {
                        cardContent.style.display = "block";
                        toggleCardButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    } else {
                        cardContent.style.display = "none";
                        toggleCardButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    }
                });
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const thClient = document.querySelector('.th-client');

        if (thClient) {
            // Ocultar la columna de encabezado correspondiente al cliente
            thClient.style.display = 'none';

            // Obtener todas las filas de la tabla
            const rows = document.querySelectorAll('tbody tr');

            // Iterar sobre las filas y ocultar la celda correspondiente al cliente
            rows.forEach(row => {
                const clientCell = row.querySelector('.client');
                if (clientCell) {
                    clientCell.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock content %}