{% extends "core/base.html" %} {% block content %} {% load static %}
<!--Main-->
<link href="{% static 'clients/css/client_detail.css' %}" rel="stylesheet">
<main class="container my-4">
    <!--Seccion 1-->
    <h4 class="title font-weight-normal animate__fadeInLeft" style="animation-duration: 0.5s !important;">{{client.first_name}} {{client.last_name}}</h4>
    {% if messages %} {% for message in messages %}
    <div class="alert alert-{{message.extra_tags}} alert-dismissible" role="alert">
        <span type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></span>
        <span class="font-weight-light">{{ message }}</span>
    </div>
    {% endfor %} {% endif %}
    <section>
        <div class="row justify-content-center">
            <div class="col-xl-3 col-sm-3 col-12 p-3">
                <!-- Swiper -->
                <div class="swiper SwiperCards">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <div class="card bg-primary box-shadow text-white">
                                <div class="card-body">
                                    <h5 class="card-title animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-trophy text-warning"></i>&nbsp;Score</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="text-warning font-weight-bold">{{client.score_label}}</p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-around align-items-center">
                                        {% if client.score_label == "Exelente" or client.score_label == "Muy Bueno" %}
                                        <div class="led-success"></div>
                                        {% elif client.score_label == "Bueno" %}
                                        <div class="led-warning"></div>
                                        {% else %}
                                        <div class="led-danger"></div>
                                        {% endif %}

                                        <span class="text-white" style="font-size: 2rem">{{client.score}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="card bg-primary box-shadow text-white">
                                <div class="card-body">
                                    <h5 class="card-title animate__fadeInDown" style="animation-duration: 0.5s !important;"><i class="fa-sharp fa-solid fa-trophy text-warning"></i>&nbsp;Score</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="text-warning font-weight-bold">{{client.score_label}}</p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-around align-items-center">
                                        {% if client.score_label == "Exelente" or client.score_label == "Muy Bueno" %}
                                        <div class="led-success"></div>
                                        {% elif client.score_label == "Bueno" %}
                                        <div class="led-warning"></div>
                                        {% else %}
                                        <div class="led-danger"></div>
                                        {% endif %}

                                        <span class="text-white" style="font-size: 2rem">{{client.score}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>
            <div class="col-xl-5 col-sm-6 col-12 p-3">
                <!-- Swiper -->
                <div class="swiper SwiperData">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide" style="height: auto;">
                            <div class="card bg-primary text-white">
                                <h5 class="title pt-3 text-center"><i class="fas fa-id-card text-warning"></i> Datos Personales</h5>
                                <div class="d-flex justify-content-around">
                                    <div class="px-2">
                                        <p><span>Domicilio: </span><strong class="text-warning">{{client.address}}</strong></p>
                                        <p><span>Estado civil: </span><strong class="text-warning">{{client.get_civil_status_display}}</strong></p>
                                        <p><span>Profesion: </span><strong class="text-warning">{{client.profession}}</strong></p>
                                    </div>
                                    <div>
                                        <p><span>DNI: </span><strong class="text-warning">{{client.dni}}</strong></p>
                                        <p><span>Domicilio Laboral: </span><strong class="text-warning">{{client.job_address}}</strong></p>
                                        <p><span>Correo: </span><strong class="text-warning">{{client.email}}</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="swiper-slide" style="height: auto;">
                            <div class="card bg-primary text-white">
                                <h5 class="title pt-3 text-center"><i class="fas fa-id-card text-warning"></i> Datos Personales</h5>
                                <div class="d-flex justify-content-around">
                                    <div class="px-2">
                                        <p><span>Domicilio: </span><strong class="text-warning">{{client.address}}</strong></p>
                                        <p><span>Estado civil: </span><strong class="text-warning">{{client.get_civil_status_display}}</strong></p>
                                        <p><span>Profesion: </span><strong class="text-warning">{{client.profession}}</strong></p>
                                    </div>
                                    <div>
                                        <p><span>DNI: </span><strong class="text-warning">{{client.dni}}</strong></p>
                                        <p><span>Domicilio Laboral: </span><strong class="text-warning">{{client.job_address}}</strong></p>
                                        <p><span>Correo: </span><strong class="text-warning">{{client.email}}</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 col-12 p-3">
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 col-12 p-3">
                <div class="card bg-primary text-white media p-4">
                    <h5 class="title py-3">Registro</h5>
                    <p class="m-0">Asesor Financiero</p>
                    <p><a class="text-warning" href="{% url 'advisers:detail' client.adviser.pk %}"><strong>{{client.adviser}}</strong></a></p>
                    <p class="m-0">Fecha de Entrada al sistema</p>
                    <p><strong>{{client.created_at|date}}</strong></p>
                    <h5 class="title pt-3">Creditos</h5>
                    {% if credits %}
                    <p>Cantidad de Creditos </p>
                    <p>Tiene un credito activo</p>
                    {% else %}
                    <p>No se registraron Creditos</p>
                    {% endif %}
                </div>
            </div>
            {% if credit_active %}
            <div class="col-xl-9 col-sm-6 col-12 p-3">
                <div class="card">
                    <h5 class="title pt-3 text-start pl-4">
                        <strong class="text-success">●</strong> Credito Activo</h5>
                    <div class="d-flex justify-content-start">
                        <div class="px-4">
                            <p class="text-start">Monto solicitado:</p>
                            <p class="text-start">Monto a devolver:</p>
                            <p class="text-start">Cuotas:</p>
                        </div>
                        <div class="px-4">
                            <p class="text-start"><strong>$ {{credit_active.amount}}</strong></p>
                            <p class="text-start"><strong>$ {{credit_active.credit_repayment_amount}}</strong></p>
                            <p class="text-start"><strong>{{credit_active.installment_num}}</strong></p>
                        </div>
                        <div class="form-group">
                            <!-- BOTON MODAL PARA PAGOS DE CUOTAS -->
                            {% if installments_available %}
                                {% include "payment/payment_form.html" %}
                            {% endif %}
                        </div>
                    </div>
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Cuota</th>
                                <th scope="col">Monto de la cuota</th>
                                <th scope="col">Fecha de vencimiento</th>
                                <th scope="col">Estado</th>
                                {% if installments_available %}
                                <th scope="col">Refinanciacion</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for installment in installments %}
                            <tr>
                                <td>{{installment.installment_number}}</td>
                                <td>{{installment.amount}}</td>
                                <td>{{installment.end_date|date}}</td>

                                {% if installment.condition == 'A Tiempo' %}
                                <td>
                                    <div class="alert alert-warning m-0 p-1 text-center rounded-pill" role="alert">
                                        <strong>● A Tiempo</strong>
                                    </div>
                                </td>
                                
                                {% elif installment.is_caduced_installment %}
                                <td>
                                    <div class="alert alert-danger m-0 p-1 text-center rounded-pill" role="alert">
                                        <strong>● Vencida</strong>
                                    </div>
                                </td>

                                {% elif installment.is_paid_installment and installment.is_refinancing_installment %}
                                <td>
                                    <!-- PONER BOTON PARA VER DETALLE DE LA REFINANCIACION  -->
                                    <a href="{% url 'credits:refinance_detail' installment.pk %}">
                                        <div class="alert alert-success m-0 p-1 text-center rounded-pill" role="alert">
                                            <strong>● Ref. Pagada</strong>
                                        </div>
                                    </a>
                                </td>

                                {% elif installment.is_refinancing_installment %}
                                <td>
                                    <!-- PONER BOTON PARA VER DETALLE DE LA REFINANCIACION  -->
                                    <a href="{% url 'credits:refinance_detail' installment.pk %}">
                                        <div class="alert alert-secondary m-0 p-1 text-center rounded-pill" role="alert">
                                            <strong>● Refinanciada</strong>
                                        </div>
                                    </a>
                                </td>
                                                                
                                {% else %}
                                <td>
                                    <div class="alert alert-success m-0 p-1 text-center rounded-pill" role="alert">
                                        <strong>● Pagada</strong>
                                    </div>
                                </td>
                                {% endif %}

                                {% if first_is_paid and not installment.is_refinancing_installment and not installment.is_paid_installment  %}
                                <td>
                                    <div type="button" class="btn" data-toggle="modal" data-target="#exampleModal{{credit_active.pk}}">
                                        <strong class="alert alert-primary m-0 p-1 text-center rounded-pill" role="alert">Refinanciar</strong>
                                    </div>
                                </td>
                                <!--Modal-->
                                    <div class="modal fade" id="exampleModal{{credit_active.pk}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel{{credit_active.pk}}" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <form action="{% url 'credits:refinance' credit_active.pk %}" method="POST">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="exampleModalLabel">Refinanciacion de Cuotas</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <h5 id="selected-count">Valor por Cuota $ {{installment.amount}}</h5>
                                                        {% csrf_token %}
                                                        {{form_ref.as_p}}
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button class="btn btn-success">Refinanciar</button>
                                                        <button type="button" class="btn btn-info m-2 rounded p-2" data-dismiss="modal">Cerrar</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                                <td>
                                    <a href="{% url 'credits:installment_update' installment.pk %}"><i class="fas fa-edit"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="card-footer p-1 bg-info rounded-bottom"></div>
                </div>
            </div>
            {% else %}
            <div class="col-xl-9 col-sm-6 col-12 p-3 text-center">
                <h5 class="title pt-3">
                    <strong class="text-danger">●</strong> Sin credito activo</h5>
                <a href="{% url 'credits:associate_credit_for_customer' client.pk %}" >
                    <div class="col-sm-6 col-12 p-3 text-center">
                        <div class="card mt-4">
                            <div class="card-content">
                                <div class="card-body">
                                    <div class="media d-flex">
                                        <div class="align-self-center">
                                            <i class="fa-sharp fa-solid fa-credit-card text-warning icon-lg"></i>
                                        </div>
                                        <div class="media-body text-right">
                                            <h5>+ Agregar Credito</h5>
                                            <h5></h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <div class="card-footer p-1 bg-info rounded-bottom"></div>
                    </div>
                </div>
                </a>
            </div>
            
            {% endif %}

        </div>
        <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 col-12 p-3">
            </div>
        </div>
    </section>
</main>
<script type="module">
    import Swiper from 'https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.esm.browser.min.js';
</script>

<!--Swipper DataClient-->
<script>
    var swiper = new Swiper(".SwiperData", {
        effect: 'flip',
        flipEffect: {
            slideShadows: false,
        },
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        coverflowEffect: {
            rotate: 50,
            stretch: 0,
            depth: 100,
            modifier: 1,
            slideShadows: true,
        },
        autoplay: {
            delay: 2100,
            disableOnInteraction: false,
        },
    });
</script>
</script>
<!--Swipper StateClient-->
<script>
    var swiper = new Swiper(".SwiperCards", {
        effect: "coverflow",
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        coverflowEffect: {
            rotate: 50,
            stretch: 0,
            depth: 100,
            modifier: 1,
            slideShadows: true,
        },
        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
            type: 'bullets',
        },
    });
</script>

<script>
    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-form-id="form_ref"]');
    const selector = document.querySelector('#id_installment_num_refinancing');
    const sumElement = document.querySelector('#id_amount');
    const interestElement = document.querySelector('#interest');
    var porcentaje;
    
    function calcularSuma() {
        let sum = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                sum += parseFloat(checkbox.value);
            }
        });
        
        console.log(selector.value);
        switch (parseInt(selector.value)) {
            case 3:
                porcentaje = 25;
                break;
            case 6:
                porcentaje = 50;
                break;
            case 9:
                porcentaje = 75;
                break;
            default:
                porcentaje = 100;
                break;
        }
        const selectorValue = parseFloat(selector.value);
        const total = (sum * (porcentaje + 100) / 100).toFixed(2);
        sumElement.value = `${total}`;
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', calcularSuma);
    });
    
    if (`{{ amount_installment|default_if_none:False }}`) {
        selector.addEventListener('change', calcularSuma);
        }
</script>
<script>
    const ledSuccess = document.querySelector('.led-success');
    const ledDanger = document.querySelector('.led-danger');
    const ledWarning = document.querySelector('.led-warning');
    let led;

    if (ledSuccess != null) {
        led = ledSuccess
    } else if (ledDanger != null) {
        led = ledDanger
    } else {
        led = ledWarning
    }

    function blink(led) {
        led.classList.toggle('blink');
    }

    setInterval(() => {
        blink(led);
    }, 1500);
</script>
{% endblock content %}